# Localization System ‚Äì Complete Setup Guide

## Overview
Your app now has a professional, production-ready i18n system using Flutter's **gen_l10n** with ARB files, ICU message support, and a Firestore-backed admin dashboard for live translation edits.

---

## Architecture

### 1. **ARB Files (Single Source of Truth)**
- **Location**: `lib/l10n/app_en.arb`, `lib/l10n/app_fr.arb`
- **Format**: JSON with ICU message syntax for plurals, genders, and selects
- **Keys**: Semantic naming (e.g., `login_title`, `transactions_count`)
- **Supported Languages**: English (EN), French (FR)

### 2. **Generated AppLocalizations Class**
- Auto-generated by `flutter gen-l10n` (triggered on build with `flutter: generate: true` in `pubspec.yaml`)
- Contains type-safe `translate(key, params: {...})` method
- Supports parameterized strings: `{expense}`, `{count}`
- Handles ICU plurals natively

### 3. **Admin Dashboard (Next.js)**
- **Path**: `/admin_panel/src/app/admin/translations/page.tsx`
- **Features**:
  - List all translations from Firestore `translations` collection
  - Search by key or text
  - Filter by category (auth, dashboard, transactions, budget, settings, general)
  - Edit FR/EN inline and save to Firestore
  - Add/delete keys on the fly
- **Access**: Protected admin-only route

### 4. **Firestore Sync**
- `TranslationService` in `lib/services/translation_service.dart`:
  - Reads/writes to `translations` collection
  - Real-time listener updates app when admin changes keys
  - `importArb()` method: Seeds ARB files to Firestore on first run
  - Batches changes for performance
- `LocaleProvider` in `lib/providers/locale_provider.dart`:
  - Manages `Locale` and persists to `SharedPreferences`
  - Triggers rebuild when language changes

---

## Usage

### **In Flutter Widgets**

```dart
import 'package:budget/l10n/app_localizations.dart';

class MyWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final locale = AppLocalizations.of(context)!;

    return Text(
      locale.translate('login_title'),
      style: const TextStyle(fontSize: 23, fontWeight: FontWeight.w700),
    );
  }
}
```

### **With Parameters**

```dart
final message = AppLocalizations.of(context)!.translate(
  'insufficient_balance_body',
  params: {
    'expense': currencyService.formatAmount(_amount),
    'balance': currencyService.formatAmount(currentBalance),
  },
);
```

### **With ICU Plurals**

```dart
// ARB key: "transactions_count": "{count, plural, =0 {No transactions} one {1 transaction} other {{count} transactions}}"
final text = AppLocalizations.of(context)!.translate(
  'transactions_count',
  params: {'count': transactions.length.toString()},
);
```

### **TrText Helper Widget**

```dart
// Simple wrapper for already-translated strings
import 'package:budget/widgets/tr_text.dart';

TrText(AppLocalizations.of(context)!.translate('app_title'))
```

---

## Admin Dashboard Workflow

### **Access the Translation Dashboard**
1. Go to: `https://[admin-url]/admin/translations` (requires admin login)
2. You'll see all keys from Firestore in a grid layout

### **Edit a Translation**
1. Click on a key card
2. Edit the French and English text
3. Click "Modify" to save
4. Changes sync to Firestore instantly
5. App users see updates on next refresh (real-time listener)

### **Add a New Key**
1. Click "Add" button
2. Enter key name (e.g., `my_new_button`)
3. Enter FR and EN translations
4. Select category (for organization)
5. Save‚Äîit's now available in the app via `translate('my_new_button')`

### **Delete a Key**
1. Click on a key card
2. Click "Delete"
3. Confirm

---

## ICU Message Examples

### **Plural Support**
```json
{
  "transaction_count": "{count, plural, =0 {Pas de transactions} one {1 transaction} other {{count} transactions}}"
}
```

Usage:
```dart
locale.translate('transaction_count', params: {'count': '5'})
// ‚Üí "5 transactions" (EN) or "5 transactions" (FR)
```

### **Selecte by Gender**
```json
{
  "user_greeting": "{gender, select, male {Monsieur} female {Madame} other {Utilisateur}}"
}
```

---

## Current Translations Added

### **Onboarding**
- `onboarding_welcome_title`, `onboarding_welcome_subtitle`
- `your_name_label`, `default_currency_label`, `monthly_income_label`
- `first_account_header`, `budget_header`, `goal_header`
- `next`, `previous`, `finish`

### **Login**
- `login_title`, `login_subtitle`, `login_subsubtitle`, `login_secure`, `login_failed`
- `email_label`, `email_required`, `email_invalid`
- `password_label`, `password_required`, `password_too_short`
- `forgot_password`

### **Dashboard**
- `dashboard_title`, `recent_history`, `quick_actions`, `total_balance`
- `debts_iou`, `goals`, `notifications`, `settings`
- `notifications_coming`

### **Transaction Validation**
- `select_account_error`, `select_category_error`, `must_be_logged_in_error`
- `budget_discipline_title`, `budget_discipline_body`
- `insufficient_balance_title`, `insufficient_balance_body`

### **Plurals (ICU)**
- `transactions_count`: Plural handler for transaction counts
- `goals_count`: Plural handler for goals
- `debts_count`: Plural handler for debts

---

## Best Practices

### **Key Naming**
- Use snake_case: `login_button_label`, not `LoginButtonLabel`
- Group by feature: `auth_*`, `dashboard_*`, `transactions_*`
- Be descriptive: `insufficient_balance_error` not `error_5`

### **Descriptions (in ARB metadata)**
```json
{
  "login_title": "Login",
  "login_title_desc": "Main heading on the login page"
}
```

### **No Hardcoded Strings**
- Every user-facing string ‚Üí ARB key
- Exception: Developer logs (prefixed with `‚ö†Ô∏è`, `‚úì`)

### **Testing Locales**
```dart
// Manually set locale in code (for testing)
context.read<LocaleProvider>().setLocale(const Locale('en'));
```

---

## Translator Workflow

### **For Non-Technical Translators**
1. Admin adds a new key or edits existing translations via the admin dashboard
2. No code knowledge required
3. Changes live immediately to all users

### **For Developers**
1. Add/update ARB files locally
2. Add new keys to admin dashboard for translators
3. Use `AppLocalizations.of(context)!.translate('key')` in Flutter code
4. Run `flutter gen-l10n` to regenerate before building

---

## Firestore Rules

Ensure your Firestore rules allow admin access to `translations`:

```firestore rules
match /translations/{document=**} {
  allow read: if request.auth != null;
  allow write: if request.auth.token.admin == true;
}
```

---

## Deployment & CI

### **Pre-Build Checks**
```bash
flutter gen-l10n  # Regenerate AppLocalizations
flutter analyze     # Check for issues
```

### **Build with Localization**
```bash
flutter build web --release   # Generates locale files
flutter build apk --release   # Android
flutter build ios --release   # iOS
```

### **CI/CD Integration**
Add to your CI pipeline:
```yaml
- run: flutter pub get
- run: flutter gen-l10n
- run: flutter analyze
- run: flutter test  # Include localization unit tests
```

---

## Troubleshooting

### **"The method 'translate' isn't defined"**
- Ensure `AppLocalizations.of(context)` is not null: `AppLocalizations.of(context)!.translate(...)`
- Verify `flutter: generate: true` in `pubspec.yaml`

### **ICU Syntax Errors**
- Apostrophes in French must be escaped: `d''√©pargne` not `d'√©pargne`
- Single quotes in messages: `'text'` ‚Üí `''text''`

### **Translations Not Showing**
- Clear cache: `flutter clean`
- Rebuild: `flutter pub get && flutter gen-l10n`
- Check Firestore `translations` collection populated

### **Admin Dashboard Not Updating**
- Verify Firestore rules allow admin writes
- Check browser console for errors
- Refresh page to see latest changes

---

## Next Steps

1. **Test on Device**: Connect device and run `flutter run -d <device_id>`
2. **Verify Admin Access**: Log in to admin panel and edit a translation
3. **Add More Keys**: Expand ARB files with additional app strings as needed
4. **Set Up CI**: Add localization checks to your deployment pipeline
5. **Translator Handoff**: Provide admin dashboard URL to translators

---

## Files Changed

- **Config**: `l10n.yaml`, `pubspec.yaml` (added `flutter: generate: true`)
- **ARB**: `lib/l10n/app_en.arb`, `lib/l10n/app_fr.arb`
- **Services**: `lib/services/translation_service.dart` (added `importArb`)
- **Providers**: `lib/providers/locale_provider.dart` (new)
- **Widgets**: `lib/widgets/tr_text.dart` (new)
- **Screens Updated**:
  - `lib/screens/auth/login_screen.dart`
  - `lib/screens/onboarding/onboarding_wizard_screen.dart`
  - `lib/screens/transactions/transaction_form_screen.dart`
- **Admin Panel**: `admin_panel/src/app/admin/translations/page.tsx` (pre-existing, ready to use)

---

**Your localization system is now complete and professional. Happy translating! üåç**
